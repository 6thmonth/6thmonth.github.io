# React Router v4에서 경로 보호(Protecting Route) 하기

## 0. 배경
김지민앤컴퍼니에서는 작년까지 주로 닷넷, 자바 기반으로 개발을 하다가 올해부터 Node.js와 React.js로 주 기술 스택을 바꾸기 시작했다. 기존에 사용자의 권한을 관리하던 방식도 Session 방식에서 Json Web Token(JWT)을 활용한 Token 방식으로 전환하여 서버와 클라이언트 앱을 분리하여 개발하고 있다.

## 1. JWT를 활용한 사용자 인증 과정
JWT를 활용한 인증 방식을 구현하기 위해서는 클라이언트 앱에서 사용자가 인증을 받은 뒤 발급받는 JWT를 로컬/세션 스토리지에 저장을 하게 된다. 만약 브라우저의 상태에 상관없이 사용자의 인증 상태를 유지하고 싶을 때에는 로컬스토리지에 저장하게 되는데 클라이언트 앱에서는 사용자가 클라이언트 앱을 처음 로드할 때 로컬스토리지에서 토큰을 확인한 뒤 서버에 인증이 유효한지 요청을 하고 답을 기다리게 된다. 클라이언트 앱에서 경로를 보호하는 이슈는 이 때 시작된다.

## 2. 앱이 처음 로드될 때 생길 수 있는 문제
만약 사용자가 브라우저를 처음 열어서 접근하는 경로가 인증이 필요한 경로(예를 들면 마이페이지 같은)라면 아마 다음과 같은 순서대로 작업이 이루어 질 것이다.

1. 사용자가 서비스 URL에 접속하고 클라이언트 앱이 로드
2. 클라이언트 앱은 로컬스토리지에서 토큰을 꺼내와 서버에 인증 요청
3. 서버는 토큰을 인증하고 인증된 결과값을 다시 클라이언트에 전송
4. 클라이언트는 서버로부터 인증된 결과값을 받아오고 난 뒤에서야 사용자가 접근한 경로에 필요한 화면을 정상적으로 보여줌

이 과정에서 사용자의 네트워크 상태에 따라 2번과 3번 사이에 발생하는 대기 시간은 꽤 오래 지속될 수 있다. 그렇다면 서버로부터 인증 결과를 기다리는 동안 아무 대처를 하지 않는다면 사용자는 어떤 화면을 보게 될까?

A: 하얀 화면
B: 인증받지 못한 상태를 가정하고 데이터가 비어있는 화면
C: (인증된 토큰인지 모르는 상태에서) 인증된 상태를 가정하고 데이터가 비어있는 화면

대부분의 서비스에서 볼수 있는 네비게이션바 우측에 내 정보를 예로 들면 B는 ‘회원가입’, ‘로그인’ 메뉴가 보일 것이고 C는 아무 정보가 보이진 않지만 로그인이 된 상태처럼 ‘내 정보’를 클릭할 수 있는 상태로 보일 것이다. 어쨌든 세가지 다 문제인 것은 확실하니 이 인증절차를 사용자로 하여금 자연스럽게 보여주기 위해 2번과 3번이 이루어지는 시간 동안 로딩화면을 띄우는 코드를 React Router v4를 활용하여 작성해보자.

## 3. React Router v4를 활용한 경로 보호 소스코드 예제
아래 소스코드는 flux 를 활용한 예제임을 참고.

{% gist the6thm0nth/fefe9a9db0c780e1dce25048da635e0f %}

1. `RouterContainer.js` 에서 `componentWillMount`를 활용하여 Router가 처음 마운트 되기 전에 현재 로컬스토리지에 저장된 토큰을 사용하여 서버에 인증을 요청하는 액션을 실행한다.
2. `AuthActions.js`에서는 현재 토큰이 존재하지 않는다면 인증을 실패한 것으로 간주하고 토큰이 있다면 서버에 인증을 요청한다. 인증에 성공하면 성공된 토큰을 스토어에 저장하고 실패하면 실패를 의미하는 `FAILED_AUTHORIZATION` 을 스토어에 저장한다.
3. 다시 `RouterContainer.js`로 돌아와서 사용자가 인증이 필요한 경로에 접근을 시도한 경우 만약 인증이 실패한 상태라면 로그인 화면으로 리다이렉트를 시킨다(19, 20번째 줄).
4. 사용자가 인증이 필요한 경로에 접근을 시도했을 때 현재 로컬스토리지에 토큰은 있으나 서버로부터 인증된 결과를 받기 전인 경우 로딩화면을 보여준다( 17, 18번째 줄).
5. 사용자가 인증이 필요한 경로에 접근을 시도했을 때 서버로부터 정상적인 결과를 받은 경우 정상적인 화면을 보여준다(21, 22번째 줄).

## 4. 마무리
[react router](https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2FReactTraining%2Freact-router)가 `v3`에서 `v4`로 넘어오면서 기존에는 `react-router` 패키지만 깔면 됐던 것들이 `react-router-dom`이라는 새로운 패키지가 필요해지는 등 많은 부분이 변경되었다. 기존에 `v3` 를 쓰고 있었다면 마이그레이션을 한 번 더 고민해보길 바라며 `react-router`의 공식문서가 굉장히 난해(?)하다고 생각하기 때문에 v4 를 도입하기 전에 많은 자료들을 참고하면 좋을 것 같다.